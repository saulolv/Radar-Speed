<svg xmlns="http://www.w3.org/2000/svg" width="900" height="600">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#000" />
    </marker>
  </defs>

  <rect width="100%" height="100%" fill="#ffffff" />

  <!-- Groups/Backgrounds -->
  <!-- Simulation Layer -->
  <rect x="20" y="20" width="860" height="100" fill="#f5f5f5" stroke="#bbbbbb" rx="10" />
  <text x="40" y="50" font-family="Arial" font-size="16" font-weight="bold" fill="#777">Simulation Layer</text>

  <!-- Core System Layer -->
  <rect x="20" y="140" width="860" height="300" fill="#e8f5e9" stroke="#bbbbbb" rx="10" />
  <text x="40" y="170" font-family="Arial" font-size="16" font-weight="bold" fill="#4caf50">Zephyr Core System</text>

  <!-- External Service Layer -->
  <rect x="20" y="460" width="860" height="120" fill="#fff3e0" stroke="#bbbbbb" rx="10" />
  <text x="40" y="490" font-family="Arial" font-size="16" font-weight="bold" fill="#ff9800">External Modules</text>


  <!-- Components -->

  <!-- Traffic Sim -->
  <rect x="60" y="60" width="160" height="50" rx="5" ry="5" fill="#b3e5fc" stroke="#0277bd" stroke-width="2"/>
  <text x="140" y="85" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle">Traffic Sim</text>
  <text x="140" y="100" font-family="Arial" font-size="10" text-anchor="middle">Injects Virtual GPIO Events</text>

  <!-- Sensor Thread -->
  <rect x="60" y="200" width="180" height="80" rx="5" ry="5" fill="#c8e6c9" stroke="#2e7d32" stroke-width="2"/>
  <text x="150" y="225" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle">Sensor Thread</text>
  <text x="150" y="245" font-family="Arial" font-size="10" text-anchor="middle">GPIO Callbacks</text>
  <text x="150" y="260" font-family="Arial" font-size="10" text-anchor="middle">FSM (Idle/Active)</text>

  <!-- Main Control -->
  <rect x="350" y="200" width="200" height="120" rx="5" ry="5" fill="#fff9c4" stroke="#fbc02d" stroke-width="2"/>
  <text x="450" y="225" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle">Main Control</text>
  <text x="450" y="245" font-family="Arial" font-size="10" text-anchor="middle">Speed Calculation</text>
  <text x="450" y="260" font-family="Arial" font-size="10" text-anchor="middle">Vehicle Classification</text>
  <text x="450" y="275" font-family="Arial" font-size="10" text-anchor="middle">Limit Logic (Light/Heavy)</text>
  <text x="450" y="290" font-family="Arial" font-size="10" text-anchor="middle">Infraction Detection</text>

  <!-- Display Thread -->
  <rect x="660" y="200" width="160" height="60" rx="5" ry="5" fill="#e1bee7" stroke="#7b1fa2" stroke-width="2"/>
  <text x="740" y="225" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle">Display Thread</text>
  <text x="740" y="245" font-family="Arial" font-size="10" text-anchor="middle">ANSI Formatting</text>

  <!-- Infraction Log (MOVED to avoid overlap) -->
  <rect x="600" y="350" width="180" height="50" rx="5" ry="5" fill="#dcedc8" stroke="#558b2f" stroke-width="2"/>
  <text x="690" y="370" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle">Infraction Log</text>
  <text x="690" y="385" font-family="Arial" font-size="10" text-anchor="middle">Ring Buffer Storage</text>

  <!-- Camera Service -->
  <rect x="350" y="500" width="200" height="60" rx="5" ry="5" fill="#ffccbc" stroke="#c62828" stroke-width="2"/>
  <text x="450" y="525" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle">Camera Service</text>
  <text x="450" y="545" font-family="Arial" font-size="10" text-anchor="middle">Plate Generation &amp; OCR Sim</text>


  <!-- Connections -->

  <!-- Sim -> Sensor -->
  <path d="M140 110 L140 200" stroke="black" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow)" />
  <text x="145" y="150" font-family="Arial" font-size="10" fill="#555">Simulated HW IRQ</text>

  <!-- Sensor -> Main -->
  <line x1="240" y1="240" x2="350" y2="240" stroke="black" stroke-width="2" marker-end="url(#arrow)" />
  <text x="295" y="230" font-family="Arial" font-size="10" text-anchor="middle" font-weight="bold">sensor_msgq</text>
  <text x="295" y="255" font-family="Arial" font-size="9" text-anchor="middle" fill="#333">sensor_data_t</text>
  <text x="295" y="265" font-family="Arial" font-size="9" text-anchor="middle" fill="#333">(time, axles)</text>

  <!-- Main -> Display -->
  <line x1="550" y1="240" x2="660" y2="240" stroke="black" stroke-width="2" marker-end="url(#arrow)" />
  <text x="605" y="230" font-family="Arial" font-size="10" text-anchor="middle" font-weight="bold">display_msgq</text>
  <text x="605" y="255" font-family="Arial" font-size="9" text-anchor="middle" fill="#333">display_data_t</text>
  <text x="605" y="265" font-family="Arial" font-size="9" text-anchor="middle" fill="#333">(speed, status, plate)</text>

  <!-- Main -> Log (UPDATED PATH) -->
  <path d="M550 280 L590 280 L590 375 L600 375" stroke="black" stroke-width="2" fill="none" marker-end="url(#arrow)" />
  <text x="630" y="300" font-family="Arial" font-size="10" text-anchor="middle">Store Record</text>

  <!-- Main <-> Camera (ZBUS) - Now Unobstructed -->
  <!-- Trigger -->
  <path d="M420 320 L420 500" stroke="blue" stroke-width="2" marker-end="url(#arrow)" />
  <text x="415" y="420" font-family="Arial" font-size="10" fill="blue" text-anchor="end" font-weight="bold">camera_api_capture()</text>
  <text x="415" y="435" font-family="Arial" font-size="9" fill="blue" text-anchor="end">msg_camera_cmd</text>

  <!-- Result -->
  <path d="M480 500 L480 320" stroke="red" stroke-width="2" marker-end="url(#arrow)" />
  <text x="485" y="415" font-family="Arial" font-size="10" fill="red" text-anchor="start" font-weight="bold">chan_camera_evt</text>
  <text x="485" y="425" font-family="Arial" font-size="9" fill="red" text-anchor="start">msg_camera_evt</text>
  <text x="485" y="435" font-family="Arial" font-size="9" fill="red" text-anchor="start">(plate data)</text>

  <!-- Display Output -->
  <line x1="740" y1="200" x2="740" y2="110" stroke="black" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow)" />
  <text x="745" y="160" font-family="Arial" font-size="10" fill="#555">Console / UART</text>

</svg>